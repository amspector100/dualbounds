<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dualbounds.generic &mdash; dualbounds 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=938c9ccc"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            dualbounds
          </a>
              <div class="version">
                0.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dualbounds</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dualbounds.generic</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dualbounds.generic</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ot</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span><span class="p">,</span> <span class="n">dist_reg</span><span class="p">,</span> <span class="n">interpolation</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">BatchedCategorical</span>
<span class="c1"># typing</span>
<span class="kn">from</span> <span class="nn">scipy.stats._distn_infrastructure</span> <span class="kn">import</span> <span class="n">rv_generic</span>
<span class="kn">import</span> <span class="nn">sklearn.base</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">MIN_NVALS</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">DISC_THRESH</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># treat vars. with &lt;= DISC_THRESH values as discrete</span>
<span class="n">CROSSFIT_WARNING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">==================================================</span>
<span class="s2">Not fitting a model because y0_dists/y1_dists were</span>
<span class="s2">directly provided. Please ensure cross-fitting is</span>
<span class="s2">employed correctly, else inference will be invalid</span>
<span class="s2">(see https://arxiv.org/abs/2310.08115). To suppress</span>
<span class="s2">this warning, set ``supress_warning=True``.</span>
<span class="s2">==================================================</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">get_default_model</span><span class="p">(</span><span class="n">discrete</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">Y_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y_model</span><span class="p">,</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">DistReg</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">Y_model</span>
	<span class="n">Y_model</span> <span class="o">=</span> <span class="s1">&#39;ridge&#39;</span> <span class="k">if</span> <span class="n">Y_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Y_model</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">discrete</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">CtsDistReg</span><span class="p">(</span>
			<span class="n">model_type</span><span class="o">=</span><span class="n">Y_model</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span>
		<span class="p">)</span>
	<span class="k">elif</span> <span class="n">discrete</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">support</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
		<span class="k">return</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">BinaryDistReg</span><span class="p">(</span>
			<span class="n">model_type</span><span class="o">=</span><span class="n">Y_model</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span>
		<span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Currently no default for non-binary discrete data&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">infer_discrete</span><span class="p">(</span><span class="n">discrete</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
	<span class="c1">### Check if discrete</span>
	<span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">discrete</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please specify the value of discrete as n &lt;= 10&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">discrete</span> <span class="ow">and</span> <span class="n">support</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please specify the value of support as n &lt;= 10&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">support</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">support</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">discrete</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">support</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">DISC_THRESH</span><span class="p">:</span>
			<span class="n">discrete</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">discrete</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="c1"># Adjust support to avoid being misleading</span>
	<span class="c1"># in the continuous case</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">discrete</span><span class="p">:</span>
		<span class="n">support</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">return</span> <span class="n">discrete</span><span class="p">,</span> <span class="n">support</span>

<span class="k">def</span> <span class="nf">_default_ylims</span><span class="p">(</span>
	<span class="n">y</span><span class="p">,</span> 
	<span class="n">y0_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">y1_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">y0_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">y1_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="o">**</span><span class="n">kwargs</span> <span class="c1"># ignored</span>
<span class="p">):</span>
	<span class="c1"># Computes default bounds on y</span>
	<span class="k">if</span> <span class="n">y0_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">y0_min</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="k">if</span> <span class="n">y1_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">y1_min</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="k">if</span> <span class="n">y0_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">y0_max</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="k">if</span> <span class="n">y1_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">y1_max</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="k">return</span> <span class="n">y0_min</span><span class="p">,</span> <span class="n">y1_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="p">,</span> <span class="n">y1_max</span>


<div class="viewcode-block" id="DualBounds">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.DualBounds">[docs]</a>
<span class="k">class</span> <span class="nc">DualBounds</span><span class="p">:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Computes dual bounds on E[f(Y(0),Y(1), X)].</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	f : function</span>
<span class="sd">		Function which defines the partially identified estimand.</span>
<span class="sd">		Must be a function of three arguments: y0, y1, x </span>
<span class="sd">		(in that order). E.g.,</span>
<span class="sd">		``f = lambda y0, y1, x : y0 &lt;= y1``</span>
<span class="sd">	X : np.array</span>
<span class="sd">		(n, p)-shaped array of covariates.</span>
<span class="sd">	W : np.array</span>
<span class="sd">		n-length array of binary treatment indicators.</span>
<span class="sd">	Y : np.array</span>
<span class="sd">		n-length array of outcome measurements.</span>
<span class="sd">	pis : np.array</span>
<span class="sd">		n-length array of propensity scores P(W=1 | X). </span>
<span class="sd">		If ``None``, will be estimated from the data.</span>
<span class="sd">	Y_model : str or dist_reg.DistReg</span>
<span class="sd">		One of [&#39;ridge&#39;, &#39;lasso&#39;, &#39;elasticnet&#39;, &#39;randomforest&#39;, &#39;knn&#39;].</span>
<span class="sd">		Alternatively, a distributional regression class inheriting </span>
<span class="sd">		from ``dist_reg.DistReg``. E.g., when ``y`` is continuous,</span>
<span class="sd">		defaults to</span>
<span class="sd">		``Y_model=dist_reg.CtsDistReg(</span>
<span class="sd">			model_type=&#39;ridge&#39;, heterosked_model=None</span>
<span class="sd">		)``.</span>
<span class="sd">	W_model : str or sklearn classifier</span>
<span class="sd">		Specifies how to estimate the propensity scores if ``pis`` is</span>
<span class="sd">		not known.  Either a str identifier as above or an sklearn</span>
<span class="sd">		classifier---see the tutorial for examples.</span>
<span class="sd">	discrete : bool</span>
<span class="sd">		If True, treats y as a discrete variable. </span>
<span class="sd">		Defaults to ``None`` (inferred from the data).</span>
<span class="sd">	support : np.array</span>
<span class="sd">		Optinal support of y, if known.</span>
<span class="sd">		Defaults to ``None`` (inferred from the data).</span>
<span class="sd">	**model_kwargs : dict</span>
<span class="sd">		Additional kwargs for the ``DistReg`` outcome model,</span>
<span class="sd">		e.g., ``eps_dist`` (for cts. y) or ``feature_transform``.</span>

<span class="sd">	Examples</span>
<span class="sd">	--------</span>
<span class="sd">	Here we fit DualBounds on P(Y(0) &lt; Y(1)) based on</span>
<span class="sd">	synthetic regression data: ::</span>
<span class="sd">		import dualbounds as db</span>

<span class="sd">		# Generate synthetic data from a heavy-tailed linear model</span>
<span class="sd">		data = db.gen_data.gen_regression_data(</span>
<span class="sd">			n=900, # Num. datapoints</span>
<span class="sd">			p=30, # Num. covariates</span>
<span class="sd">			r2=0.95, # population R^2</span>
<span class="sd">			tau=3, # average treatment effect</span>
<span class="sd">			interactions=True, # ensures treatment effect is heterogenous</span>
<span class="sd">			eps_dist=&#39;laplace&#39;, # heavy-tailed residuals</span>
<span class="sd">			sample_seed=123, # random seed</span>
<span class="sd">		)</span>

<span class="sd">		# Initialize dual bounds object</span>
<span class="sd">		dbnd = db.generic.DualBounds(</span>
<span class="sd">			f=lambda y0, y1, x: y0 &lt; y1,</span>
<span class="sd">			X=data[&#39;X&#39;], # n x p covariate matrix</span>
<span class="sd">			W=data[&#39;W&#39;], # n-length treatment vector</span>
<span class="sd">			y=data[&#39;y&#39;], # n-length outcome vector</span>
<span class="sd">			pis=data[&#39;pis&#39;], # n-length propensity scores (optional)</span>
<span class="sd">			Y_model=&#39;ridge&#39;, # model for Y | X, W</span>
<span class="sd">		)</span>

<span class="sd">		# Compute dual bounds and observe output</span>
<span class="sd">		dbnd.compute_dual_bounds(</span>
<span class="sd">			alpha=0.05 # nominal level</span>
<span class="sd">		)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> 
		<span class="n">f</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
		<span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
		<span class="n">W</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
		<span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
		<span class="n">pis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">Y_model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">DistReg</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;ridge&#39;</span><span class="p">,</span>
		<span class="n">W_model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseEstimator</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;ridge&#39;</span><span class="p">,</span>
		<span class="n">discrete</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">support</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1">### Data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="n">pis</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

		<span class="c1">### Check if discrete</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support</span> <span class="o">=</span> <span class="n">infer_discrete</span><span class="p">(</span>
			<span class="n">discrete</span><span class="o">=</span><span class="n">discrete</span><span class="p">,</span> <span class="n">support</span><span class="o">=</span><span class="n">support</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Y_model</span> <span class="o">=</span> <span class="n">Y_model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">W_model</span> <span class="o">=</span> <span class="n">W_model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span> <span class="o">=</span> <span class="n">model_kwargs</span>

		<span class="c1"># Initialize</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="k">def</span> <span class="nf">_discretize</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> 
		<span class="n">ydists</span><span class="p">,</span>
		<span class="n">nvals</span><span class="p">,</span>
		<span class="n">ymin</span><span class="p">,</span>
		<span class="n">ymax</span><span class="p">,</span>
		<span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
		<span class="n">ninterp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">min_yprob</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Helper method which discretizes Y before solving +</span>
<span class="sd">		interpolating to obtain dual variables.</span>
<span class="sd">		</span>
<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		For discrete Y: extracts conditional PMF/support points.</span>
<span class="sd">		For continuous Y: discretizes ydists along evenly spaced</span>
<span class="sd">		quantiles. Also adds extra points near the edge of the</span>
<span class="sd">		support to ensure numerical stability.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># allow for batched setting</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ydists</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">ydists</span> <span class="o">=</span> <span class="p">[</span><span class="n">ydists</span><span class="p">]</span>

		<span class="c1">### Discrete case ###</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
			<span class="n">yvals</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">yprobs</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">ydist</span> <span class="ow">in</span> <span class="n">ydists</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ydist</span><span class="p">,</span> <span class="n">utilities</span><span class="o">.</span><span class="n">BatchedCategorical</span><span class="p">):</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.discrete=True, but ydist is not a BatchedCategorical distribution.&quot;</span><span class="p">)</span>
				<span class="n">yvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ydist</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
				<span class="n">yprobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ydist</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">yprobs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


		<span class="c1">### Continuous case ###</span>
		<span class="k">if</span> <span class="n">ninterp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">ninterp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvals</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
		<span class="c1"># Case 2(a): we already have a discrete distribution</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ydists</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">utilities</span><span class="o">.</span><span class="n">BatchedCategorical</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ydist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ydists</span><span class="p">):</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ydist</span><span class="p">,</span> <span class="n">utilities</span><span class="o">.</span><span class="n">BatchedCategorical</span><span class="p">):</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
						<span class="sa">f</span><span class="s2">&quot;ydists[0] is a BatchedCategorical, ydists[</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">] is not---mixing cts/discrete dists is unsupported.&quot;</span>
					<span class="p">)</span>
			<span class="c1"># Extract and adjust everything to ensure the same support size</span>
			<span class="n">nvals_adj</span> <span class="o">=</span> <span class="n">nvals</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ninterp</span>
			<span class="n">dists_adj</span> <span class="o">=</span> <span class="p">[</span>
				<span class="n">utilities</span><span class="o">.</span><span class="n">adjust_support_size</span><span class="p">(</span>
					<span class="n">vals</span><span class="o">=</span><span class="n">ydist</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">ydist</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span> <span class="n">new_nvals</span><span class="o">=</span><span class="n">nvals_adj</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span>
				<span class="p">)</span>
				<span class="k">for</span> <span class="n">ydist</span> <span class="ow">in</span> <span class="n">ydists</span>
			<span class="p">]</span>
			<span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dists_adj</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">yprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dists_adj</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

		<span class="c1"># Case 2(b): we have a continuous distribution</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">nvals</span> <span class="o">&lt;=</span> <span class="n">MIN_NVALS</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nvals must be larger than </span><span class="si">{</span><span class="n">nvals</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
			
			<span class="c1"># make sure we get small enough quantiles</span>
			<span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nvals</span><span class="p">)</span>
			<span class="n">alpha</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nvals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">))</span>

			<span class="c1"># num of interp. pts between min/max quantiles</span>
			<span class="c1"># and ymin/ymax, added to ensure feasbility</span>
			<span class="n">nvals_adj</span> <span class="o">=</span> <span class="n">nvals</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ninterp</span> <span class="o">-</span> <span class="mi">3</span>

			<span class="c1">### Main discretization based on evenly spaced quantiles</span>
			<span class="c1"># choose endpoints of bins for disc. approx</span>
			<span class="n">endpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
				<span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">],</span>
				<span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">nvals_adj</span><span class="p">,</span> <span class="p">(</span><span class="n">nvals_adj</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nvals_adj</span><span class="p">,</span> <span class="n">nvals_adj</span><span class="p">),</span>
				<span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
			<span class="p">))</span>
			<span class="n">qs</span> <span class="o">=</span> <span class="p">(</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
			<span class="c1"># loop through batches and concatenate</span>
			<span class="n">yvals</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">dists</span> <span class="ow">in</span> <span class="n">ydists</span><span class="p">:</span>
				<span class="n">yvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
			<span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yvals</span><span class="p">)</span>
			<span class="c1"># concatenate y probs</span>
			<span class="n">yprobs</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">yprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">yprobs</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

		<span class="c1">### Insert additional support points with zero prob</span>
		<span class="k">if</span> <span class="n">ninterp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">to_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">yvals</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ninterp</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
			<span class="n">to_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
				<span class="p">[</span><span class="n">to_add</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">yvals</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ninterp</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">],</span>
				<span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
			<span class="p">)</span>
			<span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">to_add</span><span class="p">,</span> <span class="n">yvals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">yprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">to_add</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">yprobs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	
		<span class="c1"># Minimum yprob for numerical stability; then return</span>
		<span class="n">yprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">yprobs</span><span class="p">,</span> <span class="n">min_yprob</span><span class="p">)</span>
		<span class="n">yprobs</span> <span class="o">/=</span> <span class="n">yprobs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">yprobs</span>

	<span class="k">def</span> <span class="nf">_ensure_feasibility</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span>
		<span class="n">nu0</span><span class="p">,</span>
		<span class="n">nu1</span><span class="p">,</span>
		<span class="n">lower</span><span class="p">,</span>
		<span class="n">y0_min</span><span class="p">,</span>
		<span class="n">y0_max</span><span class="p">,</span>
		<span class="n">y1_min</span><span class="p">,</span>
		<span class="n">y1_max</span><span class="p">,</span>
		<span class="n">grid_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
		<span class="n">tol</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		ensures nu0 + nu1 &lt;= fvals (if lower)</span>
<span class="sd">		or nu0 + nu1 &gt;= fvals (if upper)</span>
<span class="sd">		by performing a gridsearch.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		i : int</span>
<span class="sd">			Index of which data-point we are performing</span>
<span class="sd">			this operation for.</span>
<span class="sd">		nu0 : np.array</span>
<span class="sd">			nvals0-length array of dual variables </span>
<span class="sd">			associated with Y(0)</span>
<span class="sd">		nu1 : np.array</span>
<span class="sd">			nvals1-length array of dual variables</span>
<span class="sd">			associated with Y(1)</span>
<span class="sd">		lower : bool</span>
<span class="sd">			Specifies lower vs. upper bound.</span>
<span class="sd">		ymin : float</span>
<span class="sd">			Minimum value of y</span>
<span class="sd">		ymax : float</span>
<span class="sd">			Maximum value of y</span>
<span class="sd">		grid_size : int</span>
<span class="sd">			Grid size along each dimension (y(0) and y(1)).</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		new_y0_vals : np.array</span>
<span class="sd">			``nvals0 + grid_size`` length array of new y0_vals.</span>
<span class="sd">			*Exact size may change to avoid duplicate values</span>
<span class="sd">		new_nu0 : np.array</span>
<span class="sd">			``nvals0 + grid_size`` length array of interpolated</span>
<span class="sd">			and feasible dual vars. for Y(0).</span>
<span class="sd">		new_y1_vals : np.array</span>
<span class="sd">			``nvals1 + grid_size`` length array of new y1_vals</span>
<span class="sd">		new_nu1 : np.array</span>
<span class="sd">			``nvals1 + grid_size`` length array of interpolated</span>
<span class="sd">			and feasible dual vars. for Y(1).</span>
<span class="sd">			*Exact size may change to avoid duplicate values.</span>
<span class="sd">		dx : float</span>
<span class="sd">			Maximum numerical error induced by interpolation</span>
<span class="sd">			process.</span>
<span class="sd">		objval_diff : np.array</span>
<span class="sd">			The estimated objective value change for the new</span>
<span class="sd">			dual variables.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">obj_orig</span> <span class="o">=</span> <span class="n">nu0</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">nu1</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">grid_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="c1"># interpolate to compute new dual variables</span>
			<span class="n">new_y0_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
				<span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y0_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="p">])))</span>
			<span class="n">new_y1_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
				<span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y1_min</span><span class="p">,</span> <span class="n">y1_max</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="p">])))</span>
			<span class="n">new_nu0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span><span class="p">(</span>
				<span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">nu0</span><span class="p">,</span> <span class="n">newx</span><span class="o">=</span><span class="n">new_y0_vals</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="n">new_nu1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span><span class="p">(</span>
				<span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">nu1</span><span class="p">,</span> <span class="n">newx</span><span class="o">=</span><span class="n">new_y1_vals</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="c1"># compute required bounds</span>
			<span class="n">fx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">fvals</span> <span class="o">=</span> <span class="n">fx</span><span class="p">(</span>
				<span class="n">new_y0_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">new_y1_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="p">)</span>
			<span class="c1">## Adjust elementwise (as opposed to a constant subtraction)</span>
			<span class="c1"># Calculate how far we are from feasibility</span>
			<span class="n">deltas</span> <span class="o">=</span> <span class="n">new_nu0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_nu1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">deltas</span> <span class="o">=</span> <span class="n">deltas</span> <span class="o">-</span> <span class="n">fvals</span>
			<span class="k">if</span> <span class="n">lower</span><span class="p">:</span>
				<span class="n">deltas0</span> <span class="o">=</span> <span class="n">deltas</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">dx0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">deltas0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">deltas1</span> <span class="o">=</span> <span class="n">deltas</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">dx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">deltas1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">adj_axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">dx1</span> <span class="o">&lt;=</span> <span class="n">dx0</span> <span class="k">else</span> <span class="mi">0</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">deltas0</span> <span class="o">=</span> <span class="n">deltas</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">dx0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">deltas0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">deltas1</span> <span class="o">=</span> <span class="n">deltas</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">dx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">deltas1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">adj_axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">dx1</span> <span class="o">&gt;=</span> <span class="n">dx0</span> <span class="k">else</span> <span class="mi">0</span>

			<span class="c1"># Adjust and recompute interp_nu0/interp_nu1</span>
			<span class="k">if</span> <span class="n">adj_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">new_nu0</span> <span class="o">-=</span> <span class="n">deltas0</span>
				<span class="n">nu0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span><span class="p">(</span>
					<span class="n">x</span><span class="o">=</span><span class="n">new_y0_vals</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">new_nu0</span><span class="p">,</span> <span class="n">newx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">new_nu1</span> <span class="o">-=</span> <span class="n">deltas1</span>
				<span class="n">nu1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span><span class="p">(</span>
					<span class="n">x</span><span class="o">=</span><span class="n">new_y1_vals</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">new_nu1</span><span class="p">,</span> <span class="n">newx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="p">)</span>

			<span class="c1">## Track change in objective</span>
			<span class="n">new_objval</span> <span class="o">=</span> <span class="n">nu0</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">nu1</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">objval_diff</span> <span class="o">=</span> <span class="n">obj_orig</span> <span class="o">-</span> <span class="n">new_objval</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="n">new_y0_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">new_nu0</span> <span class="o">=</span> <span class="n">nu0</span>
			<span class="n">new_y1_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">new_nu1</span> <span class="o">=</span> <span class="n">nu1</span>
			<span class="n">objval_diff</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="c1"># return</span>
		<span class="k">return</span> <span class="n">new_y0_vals</span><span class="p">,</span> <span class="n">new_nu0</span><span class="p">,</span> <span class="n">new_y1_vals</span><span class="p">,</span> <span class="n">new_nu1</span><span class="p">,</span> <span class="n">objval_diff</span>

	<span class="k">def</span> <span class="nf">_solve_single_instance</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> 
		<span class="n">probs0</span><span class="p">,</span>
		<span class="n">probs1</span><span class="p">,</span>
		<span class="n">fvals</span><span class="p">,</span>
		<span class="n">lower</span><span class="p">,</span>
		<span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">lower</span><span class="p">:</span>
			<span class="n">objval</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">lp</span><span class="o">.</span><span class="n">emd2</span><span class="p">(</span>
				<span class="n">a</span><span class="o">=</span><span class="n">probs0</span><span class="p">,</span>
				<span class="n">b</span><span class="o">=</span><span class="n">probs1</span><span class="p">,</span>
				<span class="n">M</span><span class="o">=</span><span class="n">fvals</span><span class="p">,</span>
				<span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="n">nu0</span><span class="p">,</span> <span class="n">nu1</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
			<span class="c1"># center</span>
			<span class="n">nu1</span> <span class="o">+=</span> <span class="n">nu0</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
			<span class="n">nu0</span> <span class="o">-=</span> <span class="n">nu0</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
			<span class="k">return</span> <span class="n">nu0</span><span class="p">,</span> <span class="n">nu1</span><span class="p">,</span> <span class="n">objval</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">nu0</span><span class="p">,</span> <span class="n">nu1</span><span class="p">,</span> <span class="n">objval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_single_instance</span><span class="p">(</span>
				<span class="n">probs0</span><span class="o">=</span><span class="n">probs0</span><span class="p">,</span> <span class="n">probs1</span><span class="o">=</span><span class="n">probs1</span><span class="p">,</span> <span class="n">fvals</span><span class="o">=-</span><span class="mi">1</span><span class="o">*</span><span class="n">fvals</span><span class="p">,</span>
				<span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
				<span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">nu0</span><span class="p">,</span> <span class="o">-</span><span class="n">nu1</span><span class="p">,</span> <span class="o">-</span><span class="n">objval</span>

<div class="viewcode-block" id="DualBounds.compute_dual_variables">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.DualBounds.compute_dual_variables">[docs]</a>
	<span class="k">def</span> <span class="nf">compute_dual_variables</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">y0_dists</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y0_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y0_probs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y1_dists</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y1_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y1_probs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
		<span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">ninterp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">nvals0</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
		<span class="n">nvals1</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
		<span class="n">interp_fn</span><span class="o">=</span><span class="n">interpolation</span><span class="o">.</span><span class="n">adaptive_interpolate</span><span class="p">,</span>
		<span class="n">y0_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y0_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y1_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">y1_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Uses the estimated outcome model to solve the dual optimal</span>
<span class="sd">		transport problem to obtain optimal dual variables.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		y0_dists : np.array</span>
<span class="sd">			batched scipy distribution of shape (n,) where the ith</span>
<span class="sd">			distribution is the conditional law of Yi(0) | Xi</span>
<span class="sd">			OR </span>
<span class="sd">			list of scipy dists whose shapes add up to n.</span>
<span class="sd">		y0_vals : np.array</span>
<span class="sd">			(n, nvals0)-length array of values y0 can take.</span>
<span class="sd">		y0_probs : np.array</span>
<span class="sd">			(n, nvals0)-length array where</span>
<span class="sd">			y0_probs[i, j] = P(Y(0) = yvals0[j] | Xi)</span>
<span class="sd">		y1_dists : np.array</span>
<span class="sd">			batched scipy distribution of shape (n,) where the ith</span>
<span class="sd">			distribution is the conditional law of Yi(1) | Xi</span>
<span class="sd">			OR </span>
<span class="sd">			list of scipy dists whose shapes add up to n.</span>
<span class="sd">		y1_vals : np.array</span>
<span class="sd">			(n, nvals1)-length array of values y1 can take.</span>
<span class="sd">			Ignored if ``y1_dists`` is provided.</span>
<span class="sd">		y1_probs : np.array</span>
<span class="sd">			(n, nvals1)-length array where</span>
<span class="sd">			y0_probs[i, j] = P(Y(1) = yvals1[j] | Xi).</span>
<span class="sd">			Ignored if ``y1_dists`` is provided.</span>
<span class="sd">		nvals0 : int</span>
<span class="sd">			How many values to use to discretize Y(0). </span>
<span class="sd">			Defaults to 100. Ignored for discrete Y.</span>
<span class="sd">		nvals1 : int</span>
<span class="sd">			How many values to use to discretize Y(1).</span>
<span class="sd">			Defaults to 100. Ignored for discrete Y.</span>
<span class="sd">		interp_fn : function </span>
<span class="sd">			An interpolation function with the same input/output</span>
<span class="sd">			signature as ``interpolation.linear_interpolate``,</span>
<span class="sd">			which is the default. Ignored for discrete Y.</span>
<span class="sd">		y0_min : float</span>
<span class="sd">			Minimum support for Y(0).</span>
<span class="sd">			Defaults to self.y.min() - 0.5 * (self.y.max() - self.y.min())</span>
<span class="sd">		y1_min : float</span>
<span class="sd">			Minimum support for Y(1). </span>
<span class="sd">			Defaults to self.y.min() - 0.5 * (self.y.max() - self.y.min())</span>
<span class="sd">		y0_max : float</span>
<span class="sd">			Maximum support for Y(0). </span>
<span class="sd">			Defaults to self.y.max() + 0.5 * (self.y.max() - self.y.min())</span>
<span class="sd">		y1_max : float</span>
<span class="sd">			Maximum support for Y(1). </span>
<span class="sd">			Defaults to self.y.max() + 0.5 * (self.y.max() - self.y.min())</span>
<span class="sd">		kwargs : dict</span>
<span class="sd">			kwargs for ``_ensure_feasibility`` method, e.g., ``grid_size``.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">### Key quantities for optimizer</span>
		<span class="c1"># to ensure numerical stability, we add extra quantiles</span>
		<span class="k">if</span> <span class="nb">min</span><span class="p">([</span><span class="n">nvals0</span><span class="p">,</span> <span class="n">nvals1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">MIN_NVALS</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nvals0=</span><span class="si">{</span><span class="n">nvals0</span><span class="si">}</span><span class="s2">, nvals1=</span><span class="si">{</span><span class="n">nvals1</span><span class="si">}</span><span class="s2"> must be larger than </span><span class="si">{</span><span class="n">MIN_NVALS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nvals0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nvals1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nvals0</span> <span class="o">=</span> <span class="n">nvals0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nvals1</span> <span class="o">=</span> <span class="n">nvals1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span> <span class="o">=</span> <span class="n">interp_fn</span>

		<span class="c1"># max/min yvals</span>
		<span class="n">y0_min</span><span class="p">,</span> <span class="n">y1_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="p">,</span> <span class="n">y1_max</span> <span class="o">=</span> <span class="n">_default_ylims</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">y0_min</span><span class="p">,</span> <span class="n">y1_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="o">=</span><span class="n">y0_max</span><span class="p">,</span> <span class="n">y1_max</span><span class="o">=</span><span class="n">y1_max</span>
		<span class="p">)</span>

		<span class="c1"># this discretizes if Y is continuous</span>
		<span class="k">if</span> <span class="n">y0_vals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y0_probs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">y0_vals</span><span class="p">,</span> <span class="n">y0_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize</span><span class="p">(</span>
				<span class="n">y0_dists</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nvals0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
				<span class="n">ymin</span><span class="o">=</span><span class="n">y0_min</span><span class="p">,</span>
				<span class="n">ymax</span><span class="o">=</span><span class="n">y0_max</span><span class="p">,</span>
				<span class="n">ninterp</span><span class="o">=</span><span class="n">ninterp</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="n">y1_vals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y1_probs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">y1_vals</span><span class="p">,</span> <span class="n">y1_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize</span><span class="p">(</span>
				<span class="n">y1_dists</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nvals1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
				<span class="n">ymin</span><span class="o">=</span><span class="n">y1_min</span><span class="p">,</span>
				<span class="n">ymax</span><span class="o">=</span><span class="n">y1_max</span><span class="p">,</span>
				<span class="n">ninterp</span><span class="o">=</span><span class="n">ninterp</span><span class="p">,</span>
			<span class="p">)</span>

		<span class="c1"># ensure y1_vals, y1_probs are sorted</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_probs</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">_sort_disc_dist</span><span class="p">(</span><span class="n">y0_vals</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">y0_probs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_probs</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">_sort_disc_dist</span><span class="p">(</span><span class="n">y1_vals</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">y1_probs</span><span class="p">)</span>
		<span class="c1"># Delete old values</span>
		<span class="k">del</span> <span class="n">y0_vals</span><span class="p">,</span> <span class="n">y1_vals</span><span class="p">,</span> <span class="n">y0_probs</span><span class="p">,</span> <span class="n">y1_probs</span>

		<span class="c1"># Initialize results</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nu0s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvals0</span><span class="p">))</span> <span class="c1"># first dimension = [lower, upper]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nu1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvals1</span><span class="p">))</span>
		<span class="c1"># Realized dual variables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hatnu0s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hatnu1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="c1"># estimated cond means of nu0s, nu1s</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c0s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">c1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="c1"># objective values</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span> <span class="c1"># ignored, only for backward compatability</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">objdiffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="c1"># loop through</span>
		<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimating optimal dual variables.&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">utilities</span><span class="o">.</span><span class="n">vrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
			<span class="c1"># set parameter values</span>
			<span class="n">fx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">y0</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">fvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fx</span><span class="p">(</span>
				<span class="n">y0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
				<span class="n">y1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
			<span class="p">))</span>
			<span class="c1"># solve</span>
			<span class="k">for</span> <span class="n">lower</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
				<span class="n">nu0x</span><span class="p">,</span> <span class="n">nu1x</span><span class="p">,</span> <span class="n">objval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_single_instance</span><span class="p">(</span>
					<span class="n">probs0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_probs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">probs1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_probs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">fvals</span><span class="o">=</span><span class="n">fvals</span><span class="p">,</span>
					<span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
				<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">objvals</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">objval</span>
				<span class="c1"># Save solutions</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">nu0s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu0x</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">nu1s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu1x</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">c0s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu0x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">c1s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu1x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="c1"># Compute realized dual variables</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_and_ensure_feas</span><span class="p">(</span>
					<span class="n">yi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
					<span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
					<span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> 
					<span class="n">y0_min</span><span class="o">=</span><span class="n">y0_min</span><span class="p">,</span> 
					<span class="n">y0_max</span><span class="o">=</span><span class="n">y0_max</span><span class="p">,</span>
					<span class="n">y1_min</span><span class="o">=</span><span class="n">y1_min</span><span class="p">,</span>
					<span class="n">y1_max</span><span class="o">=</span><span class="n">y1_max</span><span class="p">,</span>
					<span class="o">**</span><span class="n">kwargs</span>
				<span class="p">)</span></div>


		<span class="c1"># # Compute realized dual variables</span>
		<span class="c1"># self._compute_realized_dual_variables(</span>
		<span class="c1"># 	y=self.y, </span>
		<span class="c1"># 	y0_min=y0_min, </span>
		<span class="c1"># 	y0_max=y0_max,</span>
		<span class="c1"># 	y1_min=y1_min,</span>
		<span class="c1"># 	y1_max=y1_max,</span>
		<span class="c1"># 	**kwargs</span>
		<span class="c1"># )</span>

	<span class="k">def</span> <span class="nf">_interpolate_and_ensure_feas</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">y0_min</span><span class="p">,</span> <span class="n">y1_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="p">,</span> <span class="n">y1_max</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
	<span class="p">):</span>	
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		This is used in two places:</span>
<span class="sd">		1. _compute_realized_dual_variables</span>
<span class="sd">		2. Main loop of compute_dual_variables</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">nu0x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu0s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
		<span class="n">nu1x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu1s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
		<span class="c1"># Ensure feasibility</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
			<span class="n">y0v</span><span class="p">,</span> <span class="n">nu0adj</span><span class="p">,</span> <span class="n">y1v</span><span class="p">,</span> <span class="n">nu1adj</span><span class="p">,</span> <span class="n">odx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_feasibility</span><span class="p">(</span>
				<span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">nu0</span><span class="o">=</span><span class="n">nu0x</span><span class="p">,</span> <span class="n">nu1</span><span class="o">=</span><span class="n">nu1x</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> 
				<span class="n">y0_min</span><span class="o">=</span><span class="n">y0_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="o">=</span><span class="n">y0_max</span><span class="p">,</span>
				<span class="n">y1_min</span><span class="o">=</span><span class="n">y1_min</span><span class="p">,</span> <span class="n">y1_max</span><span class="o">=</span><span class="n">y1_max</span><span class="p">,</span> 
				<span class="o">**</span><span class="n">kwargs</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">objdiffs</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odx</span>
			<span class="c1"># interpolate to find realized values </span>
			<span class="bp">self</span><span class="o">.</span><span class="n">hatnu0s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span><span class="p">(</span>
				<span class="n">x</span><span class="o">=</span><span class="n">y0v</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">nu0adj</span><span class="p">,</span> <span class="n">newx</span><span class="o">=</span><span class="n">yi</span><span class="p">,</span>
			<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">hatnu1s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_fn</span><span class="p">(</span>
				<span class="n">x</span><span class="o">=</span><span class="n">y1v</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">nu1adj</span><span class="p">,</span> <span class="n">newx</span><span class="o">=</span><span class="n">yi</span><span class="p">,</span>
			<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">j0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">yi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">j1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">yi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">hatnu0s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu0x</span><span class="p">[</span><span class="n">j0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">hatnu1s</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lower</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu1x</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span>	



	<span class="k">def</span> <span class="nf">_compute_realized_dual_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Helper function which applies interpolation </span>
<span class="sd">		(for continuous Y) to compute realized dual variables.</span>
<span class="sd">		It also ensures feasibility through a 2D gridsearch.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">y</span>

		<span class="c1"># Create ylims</span>
		<span class="n">y0_min</span><span class="p">,</span> <span class="n">y1_min</span><span class="p">,</span> <span class="n">y0_max</span><span class="p">,</span> <span class="n">y1_max</span> <span class="o">=</span> <span class="n">_default_ylims</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y0_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0_min</span>
		<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y1_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1_min</span>
		<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y0_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0_max</span>
		<span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y1_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1_max</span>

		<span class="c1">### Compute realized hatnu1s/hatnu0s</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">lower</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_and_ensure_feas</span><span class="p">(</span>
					<span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
					<span class="n">yi</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> 
					<span class="n">y0_min</span><span class="o">=</span><span class="n">y0_min</span><span class="p">,</span> 
					<span class="n">y0_max</span><span class="o">=</span><span class="n">y0_max</span><span class="p">,</span>
					<span class="n">y1_min</span><span class="o">=</span><span class="n">y1_min</span><span class="p">,</span>
					<span class="n">y1_max</span><span class="o">=</span><span class="n">y1_max</span><span class="p">,</span>
					<span class="o">**</span><span class="n">kwargs</span>
				<span class="p">)</span>
				<span class="c1"># nu0x = self.nu0s[1-lower, i]</span>
				<span class="c1"># nu1x = self.nu1s[1-lower, i]</span>
				<span class="c1"># if not self.discrete:</span>
				<span class="c1"># 	# Ensure feasibility</span>
				<span class="c1"># 	y0v, nu0adj, y1v, nu1adj, odx = self._ensure_feasibility(</span>
				<span class="c1"># 		i=i, nu0=nu0x, nu1=nu1x, lower=lower, **kwargs</span>
				<span class="c1"># 	)</span>
				<span class="c1"># 	self.objdiffs[1-lower, i] = odx</span>
				<span class="c1"># 	# interpolate to find realized values </span>
				<span class="c1"># 	self.hatnu0s[1 - lower, i] = self.interp_fn(</span>
				<span class="c1"># 		x=y0v, y=nu0adj, newx=y[i],</span>
				<span class="c1"># 	)[0]</span>
				<span class="c1"># 	self.hatnu1s[1 - lower, i] = self.interp_fn(</span>
				<span class="c1"># 		x=y1v, y=nu1adj, newx=y[i],</span>
				<span class="c1"># 	)[0]</span>
				<span class="c1"># else:</span>
				<span class="c1"># 	j0 = np.where(self.y0_vals[i] == y[i])[0][0]</span>
				<span class="c1"># 	j1 = np.where(self.y1_vals[i] == y[i])[0][0]</span>
				<span class="c1"># 	self.hatnu0s[1 - lower, i] = nu0x[j0]</span>
				<span class="c1"># 	self.hatnu1s[1 - lower, i] = nu1x[j1]</span>

	<span class="k">def</span> <span class="nf">_compute_ipw_summands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Helper method to compute (A)IPW estimator summands.</span>
<span class="sd">		Must be run after running ``self.compute_dual_variables``</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># initialize outputs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ipw_summands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">aipw_summands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>

		<span class="c1"># compute IPW summands and AIPW summands</span>
		<span class="k">for</span> <span class="n">lower</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
			<span class="c1"># IPW</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ipw_summands</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hatnu1s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ipw_summands</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">hatnu0s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">)</span>
			<span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
			<span class="c1"># AIPW</span>
			<span class="n">mus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c0s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span>
			<span class="n">aipw1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hatnu1s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">+</span> <span class="n">mus</span> 
			<span class="n">aipw0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hatnu0s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c0s</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">)</span> <span class="o">+</span> <span class="n">mus</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">aipw_summands</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">lower</span><span class="p">]</span> <span class="o">=</span> <span class="n">aipw1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span> <span class="o">*</span> <span class="n">aipw0</span>

<div class="viewcode-block" id="DualBounds.compute_final_bounds">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.DualBounds.compute_final_bounds">[docs]</a>
	<span class="k">def</span> <span class="nf">compute_final_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aipw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Computes final estimators/ses based on the estimated</span>
<span class="sd">		dual variables.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_compute_ipw_summands</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">estimates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cis</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">compute_est_bounds</span><span class="p">(</span>
			<span class="n">summands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aipw_summands</span> <span class="k">if</span> <span class="n">aipw</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipw_summands</span><span class="p">,</span>
			<span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">estimates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">estimates</span><span class="p">,</span>
			<span class="n">ses</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ses</span><span class="p">,</span>
			<span class="n">cis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cis</span><span class="p">,</span>
		<span class="p">)</span></div>


	<span class="k">def</span> <span class="nf">_compute_cond_means</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Helper function which computes self.mu0 = E[Y(0) | X],</span>
<span class="sd">		self.mu1 = E[Y(1) | X]. Can only be run after the </span>
<span class="sd">		conditional distributions have been estimated.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span> <span class="o">=</span> <span class="n">BatchedCategorical</span><span class="p">(</span>
				<span class="n">vals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_vals</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_probs</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span> <span class="o">=</span> <span class="n">BatchedCategorical</span><span class="p">(</span>
				<span class="n">vals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_vals</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_probs</span>
			<span class="p">)</span>
		<span class="c1"># make lists</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">y0_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">y0_dists</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">y1_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">y1_dists</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span><span class="p">]</span>
		<span class="c1"># Compute</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mu0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y0_dists</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y1_dists</span><span class="p">])</span>

<div class="viewcode-block" id="DualBounds.fit_propensity_scores">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.DualBounds.fit_propensity_scores">[docs]</a>
	<span class="k">def</span> <span class="nf">fit_propensity_scores</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">nfolds</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Performs cross-fitting to fit the propensity scores.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Parse model</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">W_model</span> <span class="o">=</span> <span class="s1">&#39;ridge&#39;</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">model_cls</span> <span class="o">=</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">parse_model_type</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">W_model</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">W_model</span> <span class="o">=</span> <span class="n">model_cls</span><span class="p">()</span>
		
		<span class="c1"># Loop through</span>
		<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting propensity scores.&quot;</span><span class="p">)</span>
		<span class="n">starts</span><span class="p">,</span> <span class="n">ends</span> <span class="o">=</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">create_folds</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">nfolds</span><span class="o">=</span><span class="n">nfolds</span><span class="p">)</span>
		<span class="c1"># loop through and fit</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">W_model_fits</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">utilities</span><span class="o">.</span><span class="n">vrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
			<span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ends</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
			<span class="c1"># Pick out data from the other folds</span>
			<span class="n">not_in_fold</span> <span class="o">=</span> <span class="p">[</span>
				<span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">end</span>
			<span class="p">]</span>
			<span class="c1"># Fit </span>
			<span class="n">model_fit</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_model</span><span class="p">)</span>
			<span class="n">model_fit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
				<span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">not_in_fold</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">not_in_fold</span><span class="p">]</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">W_model_fits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_fit</span><span class="p">)</span>
			<span class="c1"># Predict out of sample</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
			<span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

		<span class="c1"># Clip</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pis</span><span class="p">,</span> <span class="n">clip</span><span class="p">),</span> <span class="mi">1</span><span class="o">-</span><span class="n">clip</span><span class="p">)</span></div>


<div class="viewcode-block" id="DualBounds.cross_fit">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.DualBounds.cross_fit">[docs]</a>
	<span class="k">def</span> <span class="nf">cross_fit</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">nfolds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
		<span class="n">suppress_warning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Performs cross-fitting to fit the outcome model.</span>


<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		y0_dists : list</span>
<span class="sd">			list of batched scipy distributions whose shapes sum to n.</span>
<span class="sd">			the ith distribution is the out-of-sample estimate of</span>
<span class="sd">			the conditional law of Yi(0) | X[i]</span>
<span class="sd">		y1_dists : list</span>
<span class="sd">			list of batched scipy distributions whose shapes sum to n.</span>
<span class="sd">			the ith distribution is the out-of-sample estimate of</span>
<span class="sd">			the conditional law of Yi(1) | X[i]</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># if pis not supplied: will use cross-fitting</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fit_propensity_scores</span><span class="p">(</span><span class="n">nfolds</span><span class="o">=</span><span class="n">nfolds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

		<span class="c1"># Fit model</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># Note: this returns the existing model</span>
			<span class="c1"># if an existing model is provided</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">Y_model</span> <span class="o">=</span> <span class="n">get_default_model</span><span class="p">(</span>
				<span class="n">discrete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span> 
				<span class="n">support</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">,</span>
				<span class="n">Y_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_model</span><span class="p">,</span>
				<span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cross-fitting the outcome model.&quot;</span><span class="p">)</span>
			<span class="n">y_out</span> <span class="o">=</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">cross_fit_predictions</span><span class="p">(</span>
				<span class="n">W</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
				<span class="n">nfolds</span><span class="o">=</span><span class="n">nfolds</span><span class="p">,</span> 
				<span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_model</span><span class="p">,</span>
				<span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_fits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oos_preds</span> <span class="o">=</span> <span class="n">y_out</span>
		<span class="k">elif</span> <span class="ow">not</span> <span class="n">suppress_warning</span><span class="p">:</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">CROSSFIT_WARNING</span><span class="p">)</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span></div>


	<span class="k">def</span> <span class="nf">compute_oos_r2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oos_preds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only implemented for settings where self.oos_preds is a list of dists&quot;</span><span class="p">)</span>
		<span class="n">starts</span><span class="p">,</span> <span class="n">ends</span> <span class="o">=</span> <span class="n">dist_reg</span><span class="o">.</span><span class="n">create_folds</span><span class="p">(</span>
			<span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
			<span class="n">nfolds</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oos_preds</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">oos_resids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">oos_preds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oos_preds</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">oos_resids</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">-</span> <span class="n">oos_preds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
		<span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oos_resids</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>


<div class="viewcode-block" id="DualBounds.compute_dual_bounds">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.DualBounds.compute_dual_bounds">[docs]</a>
	<span class="k">def</span> <span class="nf">compute_dual_bounds</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">nfolds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="n">aipw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
		<span class="n">y0_dists</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">rv_generic</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">y1_dists</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">rv_generic</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">suppress_warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="o">**</span><span class="n">solve_kwargs</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Main function which computes dual bounds in three steps:</span>
<span class="sd">		(1) cross-fitting, (2) computing optimal dual variables,</span>
<span class="sd">		and (3) computing final dual bounds.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------	</span>
<span class="sd">		nfolds : int</span>
<span class="sd">			Number of folds to use when cross-fitting. Defaults to 5.</span>
<span class="sd">		alpha : float</span>
<span class="sd">			Nominal coverage level. Defaults to 0.05.</span>
<span class="sd">		aipw : bool</span>
<span class="sd">			If true, returns AIPW estimator.</span>
<span class="sd">		y0_dists : list</span>
<span class="sd">			list of batched scipy distributions whose shapes sum to n.</span>
<span class="sd">			the ith distribution is an out-of-sample estimate of</span>
<span class="sd">			the law of Yi(0) | X[i]. This is an optional input;</span>
<span class="sd">			if provided, ``Y_model`` will be ignored.</span>
<span class="sd">		y1_dists : list</span>
<span class="sd">			list of batched scipy distributions whose shapes sum to n.</span>
<span class="sd">			the ith distribution is an out-of-sample estimate of</span>
<span class="sd">			the law of Yi(1) | X[i]. This is an optional input;</span>
<span class="sd">			if provided, ``Y_model`` will be ignored.</span>
<span class="sd">		verbose : bool</span>
<span class="sd">			If True, gives occasional progress reports.</span>
<span class="sd">			Defaults to True.</span>
<span class="sd">		suppress_warning : bool</span>
<span class="sd">			If True, suppresses a warning about cross-fitting.</span>
<span class="sd">		solve_kwargs : dict</span>
<span class="sd">			Additional (optional) kwargs for the ``compute_dual_variables``</span>
<span class="sd">			method, e.g. ``nvals0``, ``nvals1``, ``grid_size``.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		estimates : np.array</span>
<span class="sd">			2-length array, estimates of lower/upper partial ident. bound</span>
<span class="sd">		ses : np.array</span>
<span class="sd">			Standard errors of ests</span>
<span class="sd">		cis : np.array</span>
<span class="sd">			Confidence bounds based on ests and ses. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Fit model of W | X and Y | X if not provided</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span> <span class="o">=</span> <span class="n">y0_dists</span><span class="p">,</span> <span class="n">y1_dists</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cross_fit</span><span class="p">(</span>
			<span class="n">nfolds</span><span class="o">=</span><span class="n">nfolds</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="n">suppress_warning</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
		<span class="p">)</span>

		<span class="c1"># compute dual variables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compute_dual_variables</span><span class="p">(</span>
			<span class="n">y0_dists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y0_dists</span><span class="p">,</span>
			<span class="n">y1_dists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_dists</span><span class="p">,</span>
			<span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
			<span class="o">**</span><span class="n">solve_kwargs</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="c1"># compute dual bounds</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_final_bounds</span><span class="p">(</span><span class="n">aipw</span><span class="o">=</span><span class="n">aipw</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="plug_in_no_covariates">
<a class="viewcode-back" href="../../apiref.html#dualbounds.generic.plug_in_no_covariates">[docs]</a>
<span class="k">def</span> <span class="nf">plug_in_no_covariates</span><span class="p">(</span>
	<span class="n">y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_nvals</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Computes plug-in bounds on E[f(Y(0),Y(1))] without using covariates.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	y : np.array</span>
<span class="sd">		n-length array of outcomes</span>
<span class="sd">	W : np.array</span>
<span class="sd">		n-length array of treatments.</span>
<span class="sd">	f : function</span>
<span class="sd">		f(y0, y1, x) defines the objective.</span>
<span class="sd">	pis : np.array</span>
<span class="sd">		n-length array of propensity scores.</span>
<span class="sd">		Default: all equal to 1/2.</span>
<span class="sd">	B : int</span>
<span class="sd">		Number of bootstrap replications to compute standard errors.</span>
<span class="sd">		Defaults to 0 (no standard errors).</span>
<span class="sd">	verbose : bool</span>
<span class="sd">		Show progress bar while bootstrapping if verbose=True.</span>
<span class="sd">	alpha : float</span>
<span class="sd">		nominal Type I error level.</span>
<span class="sd">	max_nvals : int</span>
<span class="sd">		Maximum dimension of OT problem.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">pis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">pis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="k">if</span> <span class="n">B</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="c1"># Dists</span>
		<span class="n">y0_vals</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
		<span class="n">y0_probs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pis</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">]);</span> <span class="n">y0_probs</span> <span class="o">/=</span> <span class="n">y0_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
		<span class="n">y1_vals</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
		<span class="n">y1_probs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">pis</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">]);</span> <span class="n">y1_probs</span> <span class="o">/=</span> <span class="n">y1_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
		<span class="c1"># Reduce dimension to prevent memory errors for huge datasets</span>
		<span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">max_nvals</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">max_nvals</span><span class="o">/</span><span class="p">(</span><span class="n">max_nvals</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">max_nvals</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y0_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_nvals</span><span class="p">:</span>
			<span class="n">y0_vals</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">weighted_quantile</span><span class="p">(</span><span class="n">y0_vals</span><span class="p">,</span> <span class="n">y0_probs</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
			<span class="n">y0_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y0_vals</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y0_vals</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y1_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_nvals</span><span class="p">:</span>
			<span class="n">y1_vals</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">weighted_quantile</span><span class="p">(</span><span class="n">y1_vals</span><span class="p">,</span> <span class="n">y1_probs</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
			<span class="n">y1_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y1_vals</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y1_vals</span><span class="p">)</span>

		<span class="c1"># Fvals</span>
		<span class="n">fvals</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">y0_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y1_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="c1"># lower and upper</span>
		<span class="n">lower</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">lp</span><span class="o">.</span><span class="n">emd2</span><span class="p">(</span>
			<span class="n">a</span><span class="o">=</span><span class="n">y0_probs</span><span class="p">,</span>
			<span class="n">b</span><span class="o">=</span><span class="n">y1_probs</span><span class="p">,</span>
			<span class="n">M</span><span class="o">=</span><span class="n">fvals</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="n">upper</span> <span class="o">=</span> <span class="o">-</span><span class="n">ot</span><span class="o">.</span><span class="n">lp</span><span class="o">.</span><span class="n">emd2</span><span class="p">(</span>
			<span class="n">a</span><span class="o">=</span><span class="n">y0_probs</span><span class="p">,</span>
			<span class="n">b</span><span class="o">=</span><span class="n">y1_probs</span><span class="p">,</span>
			<span class="n">M</span><span class="o">=-</span><span class="n">fvals</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">])</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="c1"># Estimates</span>
		<span class="n">ests</span> <span class="o">=</span> <span class="n">plug_in_no_covariates</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="c1"># Bootstrap</span>
		<span class="n">bs_ests</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">utilities</span><span class="o">.</span><span class="n">vrange</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
			<span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">bs_ests</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">plug_in_no_covariates</span><span class="p">(</span>
				<span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mi">0</span>
			<span class="p">)</span>
		<span class="c1"># Bias</span>
		<span class="n">bias</span> <span class="o">=</span> <span class="n">bs_ests</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">ests</span>
		<span class="n">ses</span> <span class="o">=</span> <span class="n">bs_ests</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">cis</span> <span class="o">=</span> <span class="n">ests</span> <span class="o">-</span> <span class="n">bias</span>
		<span class="n">cis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">cis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">estimates</span><span class="o">=</span><span class="n">ests</span><span class="p">,</span>
			<span class="n">ses</span><span class="o">=</span><span class="n">ses</span><span class="p">,</span>
			<span class="n">cis</span><span class="o">=</span><span class="n">cis</span><span class="p">,</span>
		<span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Asher Spector.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>